<polymer-element name="ceci-collections">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <content></content>
  </template>
  <script>
    function bindSchema(collection) {
      collection.textContent = JSON.stringify(collection.schema);
    }
    Polymer('ceci-collections', {
      attached: function() {
        var savedData = {};
        var savedSchema = {};
        if (this.textContent !== "") {
          try {
            savedSchema = JSON.parse(this.textContent);
          } catch (e) {
            console.error("Error parsing saved schema:", e);
          }
        } else {
          this.textContent = "{}";
        }
        this.schema = savedSchema;
        var dataString = sessionStorage.getItem("ceci-collections");
        if (dataString) {
          try {
            savedData = JSON.parse(dataString);
          } catch (e) {
            console.error("Error parsing saved data:", e);
          }
        }
        this.data = savedData || {};
      },
      kinds: ["Number", "Toggle", "Text", "Name", "Address", "URL", "Color", "Image"],
      addCollection: function(name) {
        if (this.schema[name]) {
          return;
        }
        this.schema[name] = {};
        bindSchema(this);
        var detail = {
          added: name
        };
        this.fire("collectionchange", detail);
      },
      removeCollection: function(name) {
        if (!this.schema[name]) {
          return;
        }
        this.schema[name] = undefined;
        bindSchema(this);
        var detail = {
          removed: name
        };
        this.fire("collectionchange", detail);
      },
      updateCollection: function(oldName, newName) {
        if (this.schema[newName]) {
          this.removeCollection(oldName);
          return;
        }
        if (!this.schema[oldName]) {
          this.addCollection(newName);
          return;
        }
        this.schema[newName] = this.schema[oldName];
        this.schema[oldName] = undefined;
        bindSchema(this);
        var detail = {
          added: newName,
          removed: oldName
        };
        this.fire("collectionchange", detail);
      },
      addField: function(collection, name, field) {
        if (!this.schema[collection]) {
          this.addCollection(collection);
        }
        if (this.schema[collection][name]) {
          this.updateField(collection, name, field);
          return;
        }
        this.schema[collection][name] = field || {};
        bindSchema(this);
        var detail = {
          collection: collection,
          field: name,
          added: this.schema[collection][name]
        };
        this.fire("fieldchange", detail);
      },
      removeField: function(collection, name) {
        if (!this.schema[collection] || !this.schema[collection][name]) {
          return;
        }
        var item = this.schema[collection][name];
        this.schema[collection][name] = undefined;
        bindSchema(this);
        var detail = {
          collection: collection,
          field: name,
          removed: item
        };
        this.fire("fieldchange", detail);
      },
      updateField: function(collection, name, field) {
        if (!this.schema[collection]) {
          this.addCollection(collection);
        }
        if (!this.schema[collection][name]) {
          this.addField(collection, name, field);
          return;
        }
        var item = this.schema[collection][name];
        this.schema[collection][name] = field || {};
        bindSchema(this);
        var detail = {
          collection: collection,
          field: name,
          added: this.schema[collection][name],
          removed: item
        };
        this.fire("fieldchange", detail);
      },
      addItem: function(collection, item) {
        if (!this.schema[collection]) {
          this.addCollection(collection);
        }
        if (!this.data[collection]) {
          this.data[collection] = [];
        }
        this.data[collection].push(item);
        var detail = {
          collection: collection,
          added: item
        };
        this.fire("itemchanged", detail);
      },
      removeItem: function(collection, index) {
        if (!this.data[collection] || !this.data[collection][index]) {
          return;
        }
        var item = this.data[collection][index];
        this.data[collection].splice(index, 1);
        var detail = {
          collection: collection,
          removed: item
        };
        this.fire("itemchanged", detail);
      },
      updateItem: function(collection, index, item) {
        if (!this.schema[collection]) {
          this.addCollection(collection);
        }
        if (!this.data[collection]) {
          this.data[collection] = [];
        }
        var oldItem = this.data[collection][index];
        this.data[collection][index] = item;
        var detail = {
          collection: collection,
          added: item,
          removed: oldItem
        };
        this.fire("itemchanged", detail);
      },
      saveData: function() {
        sessionStorage.setItem("ceci-collections", JSON.stringify(this.data));
      }
    });
  </script>
</polymer-element>
